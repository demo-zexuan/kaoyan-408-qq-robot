#!/bin/bash
# ==============================================================================
# 运行测试脚本
# 用途：运行所有单元测试和集成测试
# ==============================================================================

set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 项目根目录
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$PROJECT_ROOT"

# ==============================================================================
# (1) 激活虚拟环境并运行测试
# ==============================================================================
echo -e "${GREEN}============================================${NC}"
echo -e "${GREEN}    运行测试${NC}"
echo -e "${GREEN}============================================${NC}"
echo ""

# 检查虚拟环境
if [ -d ".venv" ]; then
    source .venv/bin/activate
    echo -e "${GREEN}✓${NC} 虚拟环境已激活"
else
    echo -e "${RED}错误: 未找到虚拟环境${NC}"
    exit 1
fi

# ==============================================================================
# (2) 运行单元测试
# ==============================================================================
echo ""
echo -e "${YELLOW}[1/2]${NC} 运行单元测试..."
python -m pytest tests/unit/ -v --tb=short

# ==============================================================================
# (3) 运行集成测试
# ==============================================================================
echo ""
echo -e "${YELLOW}[2/2]${NC} 运行集成测试..."
python -m pytest tests/integration/ -v --tb=short

echo ""
echo -e "${GREEN}============================================${NC}"
echo -e "${GREEN}    测试完成！${NC}"
echo -e "${GREEN}============================================${NC}"
